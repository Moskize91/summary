# 🐍 新贪心算法 - 实现总结

## 改进点

### 之前的问题（层次聚类）
1. ❌ 只看指纹相似度，不考虑图的连通性
2. ❌ 节点可能属于多个蛇
3. ❌ 孤立节点也会被聚类（如节点32）

### 现在的解决方案（贪心合并）
1. ✅ **保证连通性**：只合并有边连接的节点
2. ✅ **保证互斥性**：每个节点只属于一条蛇
3. ✅ **自动过滤孤立节点**：没有边的节点不会被合并

## 算法核心

### 价值定义
```python
# 初始：两个单节点之间的边
价值(边) = -distance(fingerprint_A, fingerprint_B)

# 合并后：两个簇之间的边
价值(边) = -max_distance(簇A中所有chunk, 簇B中所有chunk)
```

### 停止策略（方案A + 方案B组合）
```
1. 节点数降低到 70% 后：激活"刹车检查"
2. 刹车检查：如果 当前价值 < 上次价值 * 0.5，立即停止
3. 强制停止：节点数降低到 30% 必然停止
```

## 测试结果

### 参数配置
```python
detector = SnakeDetector(
    max_hops=3,                # 墨水扩散距离
    stop_ratio=0.3,            # 强制停止比例
    brake_ratio=0.7,           # 刹车启动比例
    value_drop_threshold=0.5,  # 价值下降阈值
    min_cluster_size=3,        # 最小蛇长度
    distance_metric="max"      # 使用最大距离
)
```

### 运行结果
```
初始节点: 34
刹车激活: 节点数 = 25 (73.5%)
停止原因: 价值从 -2.1559 下降到 -2.1609 (触发刹车)
最终节点: 23 (67.6% of initial)
```

检测到 **4条蛇**：
1. **Snake 0** (4节点): 求葬被拒 → 心灵转变 → 入寺为僧 → 寺中苦役
2. **Snake 1** (4节点): 讨饭失尊严 → 化缘中成长 → 返乡与反思 → 朱重八的犹豫
3. **Snake 2** (3节点): 韩刘起义 → 起义燎原之势 → 官吏滥杀平民
4. **Snake 3** (3节点): 朱重八被逼绝路 → 占卜决定造反 → 决心造反

### 验证连通性
✅ 所有蛇都是连通的（每对相邻节点都有边连接）

## 代码位置

- **核心实现**: `summary/snake_detector.py` （可被其他模块引用）
- **工具函数**: `dev/snake_detector.py` （重新导出 + 辅助函数）
- **使用脚本**: `scripts/visualize.py`

## 可调参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_hops` | 3 | 墨水扩散距离（1-5） |
| `stop_ratio` | 0.3 | 强制停止比例 |
| `brake_ratio` | 0.7 | 刹车启动比例 |
| `value_drop_threshold` | 0.5 | 价值下降阈值 |
| `min_cluster_size` | 3 | 最小蛇长度 |
| `distance_metric` | "max" | 簇间距离度量（max/avg/min） |

## 优势

1. **直观的停止条件**：节点比例比 distance_threshold 更易理解
2. **自适应刹车**：价值突降时自动停止，避免过度合并
3. **保证质量**：max距离确保簇内所有节点都相似
4. **计算效率**：使用堆维护边价值，O(E log E)

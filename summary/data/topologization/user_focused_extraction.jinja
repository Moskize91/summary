You are reading a long text and need to extract key information based on the user's reading intention.

---

## RETENTION STRATEGY

{{ extraction_guidance }}

---

## TASK

Extract user-focused cognitive chunks from the new text segment by **matching against the extraction rules above**.

**Extraction Process (CRITICAL - Follow step by step, DO NOT skip):**

**STEP 1: For each piece of information, test EXCLUDE IF conditions FIRST**

**SEMANTIC EXCLUSION CHECK - Reject content matching these patterns (language-agnostic):**

**Category 1: Internal decision/planning**
- **Semantic pattern**: Content describes the protagonist making a choice, forming a plan, or deciding on future actions WITHIN THEIR MIND, not yet expressed through observable speech or actions.
- **Why exclude**: User wants interpersonal interactions, not the protagonist's internal deliberations.
- **Recognition**: Look for expressions of intention formation, decision-making processes, or planning thoughts regardless of specific words used.

**Category 2: Internal psychological state**
- **Semantic pattern**: Content describes the protagonist's thoughts, feelings, emotions, or mental state that are NOT directly observable by other characters.
- **Why exclude**: User wants observable behaviors and interpersonal dynamics, not internal monologues or psychological descriptions.
- **Recognition**: Includes mental activities (thinking, feeling, realizing, understanding), emotional states (happiness, sadness, fear), or psychological concepts (mindset, attitude, inner world) that exist only in the protagonist's mind.

**Category 3: Internal transformation**
- **Semantic pattern**: Content describes the protagonist's character development, psychological growth, or personality changes over time.
- **Why exclude**: User wants specific interaction moments, not narrative arcs of personal evolution.
- **Recognition**: Distinguish from external circumstance changes - focus on internal maturation, psychological transitions, or shifts in values/beliefs.

**Category 4: Narrator's voice**
- **Semantic pattern**: Content is the narrator's or author's commentary, historical notes, or interpretative statements about the story, rather than events within the story world.
- **Why exclude**: User wants story content, not meta-narrative commentary.
- **Recognition**: Look for phrases indicating external perspective: "the author says", "historical records show", "we can imagine", "this made him realize" (narrator interpreting character's thoughts), or statements that couldn't be known by characters in-world.

**Category 5: Generic groups (not protagonist-specific)**
- **Semantic pattern**: Content describes actions, attitudes, or treatments directed toward unnamed masses or generic social groups, without specifically naming or clearly including the protagonist.
- **Why exclude**: User wants interactions specifically involving the protagonist, not general social conditions.
- **Recognition**: Actions toward "the people", "the peasants", "civilians", "commoners", "southerners", etc. - unless the text explicitly states the protagonist is included or targeted.

**EXCLUDE IF check procedure:**
1. Read chunk content carefully and understand its semantic meaning
2. Determine if the content matches ANY of the 5 exclusion patterns above
3. If YES → REJECT immediately, do NOT extract, move to next piece of information
4. If NO → Proceed to STEP 2

**Pattern recognition examples:**

**Category 1 example (Internal decision):**
- Semantic: "Character formed the intention to become a monk"
- Why reject: Describes internal decision-making process, not yet externalized
- Category 1 match → REJECT ❌

**Category 2 example (Psychological state):**
- Semantic: "Character's mental preparation" or "Character felt anxious"
- Why reject: Describes internal mental/emotional state invisible to others
- Category 2 match → REJECT ❌

**Category 3 example (Internal transformation):**
- Semantic: "Character transformed from youth to warrior" (character arc)
- Why reject: Describes psychological/character development over time, not single interaction
- Category 3 match → REJECT ❌
- Note: Different from "Character changed jobs" (external circumstance change) ✅

**Category 4 example (Narrator's voice):**
- Semantic: "This made him realize he should rebel" or "The author states Character was brave"
- Why reject: Narrator interpreting character's thoughts OR author's commentary
- Category 4 match → REJECT ❌

**Category 5 example (Generic groups):**
- Semantic: "Officials' exploitation of the peasants"
- Why reject: Action toward generic "peasants", not specifically the protagonist
- Category 5 match → REJECT ❌
- Note: "Officials arrested the protagonist along with other peasants" is specific ✅

**STEP 2: Check ALL conditions in IF clause**

For each extraction rule in order (Rule 1, 2, 3...):
1. **Content type** - Is this the right TYPE of content?
   - Observable behaviors (speech, actions, facial expressions) ✅
   - vs Internal states (thoughts, feelings, decisions) ❌

2. **Scene/Context** - Does the CONTEXT match the rule's requirement?
   - If rule requires "first meeting", text must explicitly indicate this is the initial encounter
   - If rule requires "directed at protagonist", action must specifically target the protagonist by name or clear reference

3. **Speaker/Actor** - Is the SPEAKER/ACTOR the right entity?
   - Story character (someone within the story world) ✅
   - vs Narrator/Author (external perspective commenting on the story) ❌

If ALL three conditions satisfied → Extract with specified retention level
If ANY condition fails → Check next rule

**STEP 3: Verify extracted chunk against EXCLUDE IF again**

After extracting, double-check:
- Does chunk semantic match any of the 5 exclusion patterns?
- Is it narrator's interpretation rather than character's observable behavior?
- Is it action toward a generic group rather than the protagonist specifically?

If YES to any → DELETE the chunk

**STEP 4 (RELEVANT FALLBACK): Consider loosely-related content**

After completing STEP 1-3 for verbatim/detailed/focused extractions, **you MAY extract additional "relevant" level chunks** with looser criteria:

**When to use relevant fallback:**
- Content is RELATED to user's intent but doesn't strictly match extraction rules
- Content provides useful context for understanding extracted chunks
- Content shows patterns, background, or atmosphere relevant to the user's focus
- Content is marginally protagonist-related but not strictly protagonist-specific

**Looser exclusion criteria for relevant:**
- Category 1 (Internal decision): Still EXCLUDE ❌
- Category 2 (Psychological state): Still EXCLUDE ❌
- Category 3 (Internal transformation): Still EXCLUDE ❌
- Category 4 (Narrator's voice): **ALLOW if it provides useful context** ✅
- Category 5 (Generic groups): **ALLOW if it contextualizes protagonist's situation** ✅

**Examples of valid relevant-level extractions:**
- General social conditions that frame protagonist's experiences
- Narrator's descriptions of environment/atmosphere where protagonist interacts
- Background information about groups protagonist belongs to
- Secondary characters' general behaviors that contextualize how they treat protagonist

**Quality bar for relevant:**
- Does it help readers understand the protagonist's interpersonal situation?
- Would removing it make the story harder to follow?
- Is it connected to already-extracted chunks?

**Quantity guideline:** Aim for 1-3 relevant chunks per fragment if applicable content exists

**Common mistake patterns:**

❌ **Mistake type 1**: Extracting decisions as "reactions"
- Semantic: Character deciding to take an action
- Why wrong: Decision-making is internal process (Category 1)
- Correct approach: Extract only the OBSERVABLE action that results from the decision, not the decision itself

❌ **Mistake type 2**: Extracting psychological changes
- Semantic: Character's personality or mindset evolving over time
- Why wrong: Internal transformation narrative (Category 3)
- Correct approach: Extract specific interaction moments, not growth summaries

❌ **Mistake type 3**: Extracting general background as "treatment of protagonist"
- Semantic: Actions toward unnamed social groups
- Why wrong: Not protagonist-specific (Category 5)
- Correct approach: Only extract if protagonist is explicitly named or clearly identified as target

❌ **Mistake type 4**: Extracting narrator's commentary as "character's opinion"
- Semantic: Author's or narrator's statements about characters
- Why wrong: External meta-narrative voice (Category 4)
- Correct approach: Only extract dialogue or actions by story characters, not narrator's descriptions

✅ **Correct extraction pattern**:
- Semantic: One story character observing protagonist's composure and judging them as fearless
- Content type: Character's judgment (observable speech/thought expressed to others) ✅
- Scene/Context: Direct interpersonal interaction ✅
- Speaker: Story character (not narrator) ✅
- No exclusion patterns matched ✅
- → Extract with retention level from matched rule

**Aim for 3-6 high-quality chunks (verbatim/detailed/focused), but ONLY if rules match. Quality over quantity.**

**Additionally, you MAY extract 1-3 relevant-level chunks using the looser STEP 4 criteria.**

**CRITICAL**: If the text segment does NOT contain information matching ANY extraction rule, output an EMPTY "chunks" array `[]`. Do NOT force extraction just because working memory exists.

**Requirements:**
1. Each chunk should be:
   - For verbatim/detailed/focused: **matches at least one extraction rule** (STEP 2)
   - For relevant: **passes STEP 4 looser criteria**
   - Have a concise label (5-15 characters) summarizing the topic
   - Have full content description (one sentence)
   - Have the retention level specified by the matched rule OR "relevant" for STEP 4 extractions
   - Can be connected to existing working memory AND/OR other chunks from the same segment

2. Do NOT repeat information already in working memory

3. **For verbatim/detailed/focused extractions:**
   - Do NOT extract information that does NOT match any extraction rule, even if:
     - It connects to working memory
     - It seems important for the book's plot
     - It provides background context
   - Such information belongs to book-coherence extraction OR relevant-level extraction (STEP 4)

4. **For relevant extractions (STEP 4):**
   - Use creative judgment - over-extraction is acceptable
   - Focus on contextual information that helps understand protagonist's interpersonal world
   - Can include narrator descriptions and general conditions if they frame the story

**Current Working Memory:**
{{ working_memory }}

---

## RETENTION LEVEL GUIDELINES

Assign each chunk a retention level based on the strategy above. The retention level indicates HOW the user wants this information preserved during compression:

- **verbatim**: ENTIRE passages/sentences must be preserved word-for-word
  - ONLY use if the "Verbatim" section in the retention strategy contains actual guidance
  - If it says "(None...)" or is empty, do NOT use this level
  - Applies to FULL text passages, NOT individual words or terms
  - Example: Direct quotes, critical descriptions that user explicitly requested preserved intact

- **detailed**: Information must be captured COMPLETELY without loss
  - Content must be complete and accurate, but wording can be adjusted
  - Includes preserving specific terminology and precise facts
  - Use sparingly - only for content that MUST be captured in full
  - Example: Core arguments, essential steps, main mechanisms that user prioritizes

- **focused**: User's PRIMARY interest that can be moderately summarized
  - This should be the MAJORITY of extractions
  - Content can be compressed while preserving meaning
  - Example: Main themes, patterns, relationships the user cares about

- **relevant**: Useful but NOT essential context (can be dropped if needed for space)
  - **SPECIAL**: Has a separate, looser extraction path (see STEP 4)
  - Use generously for secondary context and supporting details
  - Helpful for understanding but not the user's main focus
  - Can include narrator descriptions and general group actions if they contextualize protagonist
  - Example: Background information, supplementary examples, social atmosphere
  - **Creative buffer**: Intentionally permissive - over-extraction is acceptable

**Distribution guideline**: Most chunks should be "focused", fewer "detailed", and "relevant" used liberally for nice-to-have context. It's OK to have many relevant chunks since they can be dropped during compression.

**What NOT to extract:**
- Do NOT extract chunks matching the "Exclude" criteria in the retention strategy
- "Exclude" means these topics should not appear as user-focused chunks (though book-coherence extraction may still include them for narrative flow)

---

## LINK STRENGTH GUIDELINES

Rate each link's dependency strength:

- **critical**: Must understand FROM to understand TO (cannot skip FROM)
- **important**: FROM provides essential context for TO (should not skip FROM)
- **helpful**: FROM and TO are related but both can stand alone (optional connection)

---

**Output Format (JSON only, no other text):**

The user will provide the new text segment in their message. Extract chunks from that text.

CRITICAL: You MUST output in this EXACT structure with "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD:

{
  "fragment_summary": "Concise 1-2 sentence narrative capturing key events/developments in this segment. Write as if continuing the story naturally - avoid meta-narrative phrases like '本章讲述了', '随后描述了', 'this chapter describes'. This will be inserted as a transition when this fragment is skipped.",
  "chunks": [
    {
      "temp_id": "A",
      "label": "brief topic label (5-15 chars)",
      "content": "full description of the key information",
      "source_sentences": ["原文句子1（完整复制）", "原文句子2（完整复制）"],
      "retention": "focused"
    },
    {
      "temp_id": "B",
      "label": "another topic label",
      "content": "another description",
      "source_sentences": ["原文句子（完整复制）"],
      "retention": "detailed"
    }
  ],
  "links": [
    {"from": 1, "to": "A", "strength": "important"},
    {"from": "A", "to": "B", "strength": "critical"},
    {"from": 3, "to": "B", "strength": "helpful"}
  ]
}

**Field Explanations:**
- "fragment_summary": Concise narrative of key events/developments in this segment (1-2 sentences)
  - Write as NARRATIVE, not meta-commentary (e.g., "朱元璋加入义军" NOT "本章讲述朱元璋加入义军的过程")
  - Capture what happens in the story's natural progression (not user's focus areas)
  - Should read like a compressed continuation of the book itself
  - Avoid meta-phrases: "本章描述了", "随后讲述了", "接着介绍了", "this chapter describes", "then it explains"
  - Write in the same language and narrative tone as the original text

**Style examples for fragment_summary:**
  ✅ GOOD: "主角进入新城市，开始寻找工作" (direct narrative)
  ✅ GOOD: "战争爆发，小镇陷入混乱" (direct narrative)
  ❌ BAD: "本章讲述了主角进入新城市的过程" (meta-commentary)
  ❌ BAD: "随后描述了战争爆发导致的混乱" (meta-commentary)

- "chunks": Array of new information extracted from the text
  - "temp_id": Use letters like "A", "B", "C" for chunks in this extraction
  - "label": 5-15 character summary
  - "content": Full one-sentence description
  - "source_sentences": Array of original sentences from the text that this chunk is based on
    - **Default: Copy complete original text** for accurate sentence ID mapping
    - If a sentence is very long (200+ characters), you may use ellipsis to shorten it
    - **Ellipsis rules (CRITICAL)**:
      - Format: "prefix...suffix" - exactly ONE "..." (three dots) per string
      - NOT allowed: multiple ellipsis like "text...more...end" ❌
      - NOT allowed: other formats like "……" or "..…" ❌
      - The prefix and suffix together must uniquely identify the sentence
    - Example: "这是一个非常长的句子，包含了大量的细节描述...最终得出了重要的结论。"
  - "retention": One of "verbatim", "detailed", "focused", or "relevant"

- "links": Array of relationships between chunks
  - "from" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "to" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "strength": One of "critical", "important", or "helpful"
  - Use empty array [] if no relationships exist

**IMPORTANT:**
1. The order matters! Output "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD.
2. Every chunk MUST have a "retention" field with one of the four valid values.
3. Every link MUST have a "strength" field with one of the three valid values.
4. The "fragment_summary" field is REQUIRED - it must always be present even if there are no chunks.

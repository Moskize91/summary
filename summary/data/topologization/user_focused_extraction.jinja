You are reading a long text and need to extract key information based on the user's reading intention.

---

## RETENTION STRATEGY

{{ extraction_guidance }}

---

## TASK

Extract user-focused cognitive chunks from the new text segment by **matching against the extraction rules above**.

**Extraction Process (CRITICAL - Follow step by step, DO NOT skip):**

**STEP 1: For each piece of information, test EXCLUDE IF conditions FIRST**

**CRITICAL KEYWORD CHECK - If chunk content contains ANY of these keywords, REJECT immediately:**

**Category 1: Internal decision/planning**
- "决定", "决策", "选择", "打算", "计划"

**Category 2: Internal psychological state**
- "心理", "想法", "内心", "思考", "情感", "感受", "认为", "觉得", "意识到", "明白", "懂得"
- "心情", "情绪", "感觉", "感到"

**Category 3: Internal transformation**
- "转变", "变化" (when describing psychological/character changes, not external circumstances)
- "成长", "蜕变", "进步" (when describing character development)

**Category 4: Narrator's voice**
- "我们可以", "我们不得不", "作者说", "史书记载", "可以想象"
- "这让他", "使得他", "让他意识到" (narrator interpreting character's thoughts)

**Category 5: Generic groups (not specific to protagonist)**
- "对百姓", "对民夫", "对农民", "对南人" (unless specifically "including Zhu Yuanzhang")

**EXCLUDE IF check procedure:**
1. Read chunk content carefully
2. Check for ANY keyword from Categories 1-5
3. If found → REJECT, do NOT extract, move to next piece of information
4. If NOT found → Proceed to STEP 2

**Examples of CORRECT rejection:**
- "朱重八决定当和尚" → Contains "决定" (Category 1) → REJECT ❌
- "朱重八的心理准备" → Contains "心理" (Category 2) → REJECT ❌
- "朱重八从少年转变成战士" → Contains "转变" describing character change (Category 3) → REJECT ❌
- "这让他意识到要造反" → Contains "让他意识到" (Category 4) → REJECT ❌
- "元朝官吏对百姓的盘剥" → Contains "对百姓" (Category 5) → REJECT ❌

**STEP 2: Check ALL conditions in IF clause**

For each extraction rule in order (Rule 1, 2, 3...):
1. **Content type** - Is this the right TYPE of content? (speech/action/expression vs internal thought)
2. **Scene/Context** - Does the CONTEXT match the requirement?
   - Example: Rule 1 requires "first meeting" - if text doesn't explicitly say "第一次", "初次", "first meeting", it does NOT match
   - Example: Rule 3 requires "directed at protagonist" - if action is toward generic "百姓"/"民夫", it does NOT match
3. **Speaker/Actor** - Is the SPEAKER the right entity?
   - Story character ✅ vs Narrator/Author ❌
   - Phrases like "作者说", "史书记载", "我们可以看到" = Narrator, NOT story character

If ALL three conditions satisfied → Extract with specified retention level
If ANY condition fails → Check next rule

**STEP 3: Verify extracted chunk against EXCLUDE IF again**

After extracting, double-check:
- Does chunk content contain excluded keywords?
- Is it narrator's summary rather than character's action? (如"这让他意识到", "他开始懂得")
- Is it general background not specific to protagonist? (如"元朝官吏对百姓", not "对朱元璋")

If YES to any → DELETE the chunk

**Common mistakes to avoid (with examples):**

❌ **Mistake 1**: Extracting decisions as "reactions"
- Text: "朱重八决定当和尚"
- Contains "决定" → EXCLUDE IF triggered → Do NOT extract

❌ **Mistake 2**: Extracting psychological changes
- Text: "朱重八从少年转变成战士"
- "转变" = internal change, not observable action → Do NOT extract

❌ **Mistake 3**: Extracting general background as "treatment of protagonist"
- Text: "元朝官吏对百姓的盘剥"
- "百姓" ≠ "朱元璋" specifically → Rule 3 condition fails → Do NOT extract

❌ **Mistake 4**: Extracting narrator's commentary as "character's opinion"
- Text: "作者说朱重八作战勇敢"
- Speaker = Author, not story character → Condition fails → Do NOT extract

✅ **Correct extraction**:
- Text: "郭子兴看朱元璋镇定，认为这是个吓不倒的人"
- Content type: Character's judgment ✅
- Scene/Context: Interpersonal interaction ✅
- Speaker: Story character (郭子兴) ✅
- No excluded keywords ✅
- → Extract as "focused"

**Aim for 3-6 chunks, but ONLY if rules match. Quality over quantity.**

**CRITICAL**: If the text segment does NOT contain information matching ANY extraction rule, output an EMPTY "chunks" array `[]`. Do NOT force extraction just because working memory exists.

**Requirements:**
1. Each chunk should be:
   - A meaningful unit that **matches at least one extraction rule**
   - Have a concise label (5-15 characters) summarizing the topic
   - Have full content description (one sentence)
   - Have the retention level specified by the matched rule
   - Can be connected to existing working memory AND/OR other chunks from the same segment

2. Do NOT repeat information already in working memory

3. **Do NOT extract information that does NOT match any extraction rule, even if:**
   - It connects to working memory
   - It seems important for the book's plot
   - It provides background context
   - Such information belongs to book-coherence extraction (a different phase), NOT user-focused extraction

**Current Working Memory:**
{{ working_memory }}

---

## RETENTION LEVEL GUIDELINES

Assign each chunk a retention level based on the strategy above. The retention level indicates HOW the user wants this information preserved during compression:

- **verbatim**: ENTIRE passages/sentences must be preserved word-for-word
  - ONLY use if the "Verbatim" section in the retention strategy contains actual guidance
  - If it says "(None...)" or is empty, do NOT use this level
  - Applies to FULL text passages, NOT individual words or terms
  - Example: Direct quotes, critical descriptions that user explicitly requested preserved intact

- **detailed**: Information must be captured COMPLETELY without loss
  - Content must be complete and accurate, but wording can be adjusted
  - Includes preserving specific terminology and precise facts
  - Use sparingly - only for content that MUST be captured in full
  - Example: Core arguments, essential steps, main mechanisms that user prioritizes

- **focused**: User's PRIMARY interest that can be moderately summarized
  - This should be the MAJORITY of extractions
  - Content can be compressed while preserving meaning
  - Example: Main themes, patterns, relationships the user cares about

- **relevant**: Useful but NOT essential context (can be dropped if needed for space)
  - Use generously for secondary context and supporting details
  - Helpful for understanding but not the user's main focus
  - Example: Background information, supplementary examples

**Distribution guideline**: Most chunks should be "focused", fewer "detailed", and "relevant" used liberally for nice-to-have context.

**What NOT to extract:**
- Do NOT extract chunks matching the "Exclude" criteria in the retention strategy
- "Exclude" means these topics should not appear as user-focused chunks (though book-coherence extraction may still include them for narrative flow)

---

## LINK STRENGTH GUIDELINES

Rate each link's dependency strength:

- **critical**: Must understand FROM to understand TO (cannot skip FROM)
- **important**: FROM provides essential context for TO (should not skip FROM)
- **helpful**: FROM and TO are related but both can stand alone (optional connection)

---

**Output Format (JSON only, no other text):**

The user will provide the new text segment in their message. Extract chunks from that text.

CRITICAL: You MUST output in this EXACT structure with "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD:

{
  "fragment_summary": "Concise 1-2 sentence narrative capturing key events/developments in this segment. Write as if continuing the story naturally - avoid meta-narrative phrases like '本章讲述了', '随后描述了', 'this chapter describes'. This will be inserted as a transition when this fragment is skipped.",
  "chunks": [
    {
      "temp_id": "A",
      "label": "brief topic label (5-15 chars)",
      "content": "full description of the key information",
      "source_sentences": ["原文句子1（完整复制）", "原文句子2（完整复制）"],
      "retention": "focused"
    },
    {
      "temp_id": "B",
      "label": "another topic label",
      "content": "another description",
      "source_sentences": ["原文句子（完整复制）"],
      "retention": "detailed"
    }
  ],
  "links": [
    {"from": 1, "to": "A", "strength": "important"},
    {"from": "A", "to": "B", "strength": "critical"},
    {"from": 3, "to": "B", "strength": "helpful"}
  ]
}

**Field Explanations:**
- "fragment_summary": Concise narrative of key events/developments in this segment (1-2 sentences)
  - Write as NARRATIVE, not meta-commentary (e.g., "朱元璋加入义军" NOT "本章讲述朱元璋加入义军的过程")
  - Capture what happens in the story's natural progression (not user's focus areas)
  - Should read like a compressed continuation of the book itself
  - Avoid meta-phrases: "本章描述了", "随后讲述了", "接着介绍了", "this chapter describes", "then it explains"
  - Write in the same language and narrative tone as the original text

**Style examples for fragment_summary:**
  ✅ GOOD: "主角进入新城市，开始寻找工作" (direct narrative)
  ✅ GOOD: "战争爆发，小镇陷入混乱" (direct narrative)
  ❌ BAD: "本章讲述了主角进入新城市的过程" (meta-commentary)
  ❌ BAD: "随后描述了战争爆发导致的混乱" (meta-commentary)

- "chunks": Array of new information extracted from the text
  - "temp_id": Use letters like "A", "B", "C" for chunks in this extraction
  - "label": 5-15 character summary
  - "content": Full one-sentence description
  - "source_sentences": Array of original sentences from the text that this chunk is based on
    - **Default: Copy complete original text** for accurate sentence ID mapping
    - If a sentence is very long (200+ characters), you may use ellipsis to shorten it
    - **Ellipsis rules (CRITICAL)**:
      - Format: "prefix...suffix" - exactly ONE "..." (three dots) per string
      - NOT allowed: multiple ellipsis like "text...more...end" ❌
      - NOT allowed: other formats like "……" or "..…" ❌
      - The prefix and suffix together must uniquely identify the sentence
    - Example: "这是一个非常长的句子，包含了大量的细节描述...最终得出了重要的结论。"
  - "retention": One of "verbatim", "detailed", "focused", or "relevant"

- "links": Array of relationships between chunks
  - "from" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "to" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "strength": One of "critical", "important", or "helpful"
  - Use empty array [] if no relationships exist

**IMPORTANT:**
1. The order matters! Output "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD.
2. Every chunk MUST have a "retention" field with one of the four valid values.
3. Every link MUST have a "strength" field with one of the three valid values.
4. The "fragment_summary" field is REQUIRED - it must always be present even if there are no chunks.

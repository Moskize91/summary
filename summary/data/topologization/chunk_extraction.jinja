You are reading a long text and need to extract key information while maintaining continuity.

---

## EXTRACTION GUIDANCE

### User-Focused Chunks (Type: "user_focused")

{{ extraction_guidance }}

---

### Book-Coherence Chunks (Type: "book_coherence")

**What to extract:**
Extract information essential for understanding the book's logic and narrative flow, regardless of the reader's stated preferences. This includes:
- First introductions of key concepts, characters, or settings that will be referenced later
- Causal relationships that drive the plot or argument forward
- Context and background that makes later content comprehensible
- Turning points or transitions in the narrative structure
- Definitions, rules, or constraints established by the author that affect subsequent content

**Link criteria:**
Connect book-coherence chunks when there are clear logical dependencies, cause-and-effect relationships, or narrative continuity between them. Link chunks that form a chain of reasoning, a sequence of events, or a progression of ideas essential to the book's structure.

---

### Extraction Balance

**Suggested ratio:** Approximately 60-70% user-focused chunks and 30-40% book-coherence chunks per text segment.

**Integration principle:** User-focused chunks capture what the reader cares about and form the core of the extraction. Book-coherence chunks serve as essential scaffolding, ensuring the extracted information remains logically connected and comprehensible as a standalone summary.

---

## TASK

Extract cognitive chunks from the new text segment based on the guidance above. You need to extract BOTH types of chunks.

Aim for 3-6 chunks total per segment, balancing between the two types.

**Requirements:**
1. Each chunk should be:
   - A meaningful unit (events, concepts, facts, decisions, relationships)
   - Have a concise label (5-15 characters) summarizing the topic
   - Have full content description (one sentence)
   - Tagged with its type: "user_focused" or "book_coherence"
   - Can be connected to existing working memory AND/OR other chunks from the same segment

2. Do NOT repeat information already in working memory

**Current Working Memory:**
{{ working_memory }}

---

**Output Format (JSON only, no other text):**

The user will provide the new text segment in their message. Extract chunks from that text.

CRITICAL: You MUST output in this EXACT structure with "chunks" FIRST, then "links" SECOND:

{
  "chunks": [
    {
      "temp_id": "A",
      "type": "user_focused",
      "label": "brief topic label (5-15 chars)",
      "content": "full description of the key information",
      "source_sentences": ["original sentence 1 from text", "original sentence 2 from text"]
    },
    {
      "temp_id": "B",
      "type": "book_coherence",
      "label": "another topic label",
      "content": "another description",
      "source_sentences": ["original sentence from text"]
    }
  ],
  "links": [
    {"from": 1, "to": "A"},
    {"from": "A", "to": "B"},
    {"from": 3, "to": "B"}
  ]
}

**Field Explanations:**
- "chunks": Array of new information extracted from the text
  - "temp_id": Use letters like "A", "B", "C" for chunks in this extraction
  - "type": MUST be either "user_focused" or "book_coherence"
  - "label": 5-15 character summary
  - "content": Full one-sentence description
  - "source_sentences": Array of original sentences from the text that this chunk is based on (copy exact text)

- "links": Array of relationships between chunks
  - "from" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "to" can be: working memory ID (number) OR temp_id (string from chunks above)
  - Create links based on the criteria specified in the guidance above
  - Use empty array [] if no relationships exist

**IMPORTANT:**
1. The order matters! Output "chunks" FIRST, then "links" SECOND.
2. Every chunk MUST have a "type" field.
3. Balance the two types of chunks according to the suggested ratio.
4. Follow the specific extraction and linking criteria from the guidance above.

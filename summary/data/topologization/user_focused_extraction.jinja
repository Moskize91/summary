You are reading a long text and need to extract key information based on the user's reading intention.

---

## RETENTION STRATEGY

{{ extraction_guidance }}

---

## TASK

Extract user-focused cognitive chunks from the new text segment based on the retention strategy above.

Aim for 3-6 chunks that align with the user's intention. **Be selective - not every piece of information deserves extraction. Only extract what genuinely matches the retention strategy.**

**Requirements:**
1. Each chunk should be:
   - A meaningful unit (events, concepts, facts, decisions, relationships) that matches the user's interest
   - Have a concise label (5-15 characters) summarizing the topic
   - Have full content description (one sentence)
   - Have a retention level indicating how it should be preserved
   - Can be connected to existing working memory AND/OR other chunks from the same segment

2. Do NOT repeat information already in working memory

**Current Working Memory:**
{{ working_memory }}

---

## RETENTION LEVEL GUIDELINES

Assign each chunk a retention level based on the strategy above. The retention level indicates HOW the user wants this information preserved during compression:

- **verbatim**: ENTIRE passages/sentences must be preserved word-for-word
  - ONLY use if the "Verbatim" section in the retention strategy contains actual guidance
  - If it says "(None...)" or is empty, do NOT use this level
  - Applies to FULL text passages, NOT individual words or terms
  - Example: Direct quotes, critical descriptions that user explicitly requested preserved intact

- **detailed**: Information must be captured COMPLETELY without loss
  - Content must be complete and accurate, but wording can be adjusted
  - Includes preserving specific terminology and precise facts
  - Use sparingly - only for content that MUST be captured in full
  - Example: Core arguments, essential steps, main mechanisms that user prioritizes

- **focused**: User's PRIMARY interest that can be moderately summarized
  - This should be the MAJORITY of extractions
  - Content can be compressed while preserving meaning
  - Example: Main themes, patterns, relationships the user cares about

- **relevant**: Useful but NOT essential context (can be dropped if needed for space)
  - Use generously for secondary context and supporting details
  - Helpful for understanding but not the user's main focus
  - Example: Background information, supplementary examples

**Distribution guideline**: Most chunks should be "focused", fewer "detailed", and "relevant" used liberally for nice-to-have context.

**What NOT to extract:**
- Do NOT extract chunks matching the "Exclude" criteria in the retention strategy
- "Exclude" means these topics should not appear as user-focused chunks (though book-coherence extraction may still include them for narrative flow)

---

## LINK STRENGTH GUIDELINES

Rate each link's dependency strength:

- **critical**: Must understand FROM to understand TO (cannot skip FROM)
- **important**: FROM provides essential context for TO (should not skip FROM)
- **helpful**: FROM and TO are related but both can stand alone (optional connection)

---

**Output Format (JSON only, no other text):**

The user will provide the new text segment in their message. Extract chunks from that text.

CRITICAL: You MUST output in this EXACT structure with "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD:

{
  "fragment_summary": "Concise 1-2 sentence narrative capturing key events/developments in this segment. Write as if continuing the story naturally - avoid meta-narrative phrases like '本章讲述了', '随后描述了', 'this chapter describes'. This will be inserted as a transition when this fragment is skipped.",
  "chunks": [
    {
      "temp_id": "A",
      "type": "user_focused",
      "label": "brief topic label (5-15 chars)",
      "content": "full description of the key information",
      "source_sentences": ["original sentence 1 from text", "original sentence 2 from text"],
      "retention": "focused"
    },
    {
      "temp_id": "B",
      "type": "user_focused",
      "label": "another topic label",
      "content": "another description",
      "source_sentences": ["original sentence from text"],
      "retention": "detailed"
    }
  ],
  "links": [
    {"from": 1, "to": "A", "strength": "important"},
    {"from": "A", "to": "B", "strength": "critical"},
    {"from": 3, "to": "B", "strength": "helpful"}
  ]
}

**Field Explanations:**
- "fragment_summary": Concise narrative of key events/developments in this segment (1-2 sentences)
  - Write as NARRATIVE, not meta-commentary (e.g., "朱元璋加入义军" NOT "本章讲述朱元璋加入义军的过程")
  - Capture what happens in the story's natural progression (not user's focus areas)
  - Should read like a compressed continuation of the book itself
  - Avoid meta-phrases: "本章描述了", "随后讲述了", "接着介绍了", "this chapter describes", "then it explains"
  - Write in the same language and narrative tone as the original text

**Style examples for fragment_summary:**
  ✅ GOOD: "主角进入新城市，开始寻找工作" (direct narrative)
  ✅ GOOD: "战争爆发，小镇陷入混乱" (direct narrative)
  ❌ BAD: "本章讲述了主角进入新城市的过程" (meta-commentary)
  ❌ BAD: "随后描述了战争爆发导致的混乱" (meta-commentary)

- "chunks": Array of new information extracted from the text
  - "temp_id": Use letters like "A", "B", "C" for chunks in this extraction
  - "type": MUST be "user_focused"
  - "label": 5-15 character summary
  - "content": Full one-sentence description
  - "source_sentences": Array of original sentences from the text that this chunk is based on (copy exact text)
  - "retention": One of "verbatim", "detailed", "focused", or "relevant"

- "links": Array of relationships between chunks
  - "from" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "to" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "strength": One of "critical", "important", or "helpful"
  - Use empty array [] if no relationships exist

**IMPORTANT:**
1. The order matters! Output "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD.
2. Every chunk MUST have a "type" field set to "user_focused".
3. Every chunk MUST have a "retention" field with one of the four valid values.
4. Every link MUST have a "strength" field with one of the three valid values.
5. The "fragment_summary" field is REQUIRED - it must always be present even if there are no user-focused chunks.

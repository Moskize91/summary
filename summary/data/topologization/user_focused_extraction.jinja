You are reading a long text and need to extract key information based on the user's reading intention.

---

## RETENTION STRATEGY

{{ extraction_guidance }}

---

## TASK

Extract user-focused cognitive chunks from the new text segment based on the retention strategy above.

Aim for 3-6 chunks that align with the user's intention. **Be selective - not every piece of information deserves extraction. Only extract what genuinely matches the retention strategy.**

**Requirements:**
1. Each chunk should be:
   - A meaningful unit (events, concepts, facts, decisions, relationships) that matches the user's interest
   - Have a concise label (5-15 characters) summarizing the topic
   - Have full content description (one sentence)
   - Have a retention level indicating how it should be preserved
   - Can be connected to existing working memory AND/OR other chunks from the same segment

2. Do NOT repeat information already in working memory

**Current Working Memory:**
{{ working_memory }}

---

## RETENTION LEVEL GUIDELINES

Assign each chunk a retention level based on the strategy above (this is NOT about objective importance, but about HOW the user wants it preserved):

- **verbatim**: User explicitly requested ENTIRE passages/sentences be preserved word-for-word
  - ONLY use this if the Verbatim section in the retention strategy contains actual guidance
  - If Verbatim says "(None ...)" or is empty, do NOT use this level
  - This applies to FULL text passages, NOT individual words or terms
- **detailed**: User needs complete information retained without compression (content complete and accurate, but wording can be adjusted; includes preserving specific terminology)
  - Use sparingly - only for content that MUST be captured completely
- **focused**: User's primary interest that can be moderately summarized
  - This should be the majority of extractions
- **relevant**: User finds this useful but not essential (can be dropped if needed for space)
  - Use generously for secondary context and supporting details

**Distribution guideline**: Most chunks should be "focused", fewer should be "detailed", and "relevant" should be used liberally for nice-to-have context. Don't be afraid to use "relevant" - it means "useful but droppable", not "unimportant".

**What NOT to extract:**
- Do NOT extract chunks that match the "Exclude" criteria in the retention strategy
- "Exclude" means these topics should not appear as user-focused chunks at all

---

## LINK STRENGTH GUIDELINES

Rate each link's dependency strength:

- **critical**: Must understand FROM to understand TO (cannot skip FROM)
- **important**: FROM provides essential context for TO (should not skip FROM)
- **helpful**: FROM and TO are related but both can stand alone (optional connection)

---

**Output Format (JSON only, no other text):**

The user will provide the new text segment in their message. Extract chunks from that text.

CRITICAL: You MUST output in this EXACT structure with "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD:

{
  "fragment_summary": "Brief 1-2 sentence summary of the entire text segment's main narrative content (not user-focused, but book's natural progression). This will be used as a transition when this fragment is skipped.",
  "chunks": [
    {
      "temp_id": "A",
      "type": "user_focused",
      "label": "brief topic label (5-15 chars)",
      "content": "full description of the key information",
      "source_sentences": ["original sentence 1 from text", "original sentence 2 from text"],
      "retention": "focused"
    },
    {
      "temp_id": "B",
      "type": "user_focused",
      "label": "another topic label",
      "content": "another description",
      "source_sentences": ["original sentence from text"],
      "retention": "detailed"
    }
  ],
  "links": [
    {"from": 1, "to": "A", "strength": "important"},
    {"from": "A", "to": "B", "strength": "critical"},
    {"from": 3, "to": "B", "strength": "helpful"}
  ]
}

**Field Explanations:**
- "fragment_summary": Brief summary of the entire text segment (1-2 sentences)
  - Describe the main narrative or events in this segment, not focused on user intent
  - Should work as a natural transition paragraph when this fragment is skipped
  - Write in the same language as the text segment

- "chunks": Array of new information extracted from the text
  - "temp_id": Use letters like "A", "B", "C" for chunks in this extraction
  - "type": MUST be "user_focused"
  - "label": 5-15 character summary
  - "content": Full one-sentence description
  - "source_sentences": Array of original sentences from the text that this chunk is based on (copy exact text)
  - "retention": One of "verbatim", "detailed", "focused", or "relevant"

- "links": Array of relationships between chunks
  - "from" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "to" can be: working memory ID (number) OR temp_id (string from chunks above)
  - "strength": One of "critical", "important", or "helpful"
  - Use empty array [] if no relationships exist

**IMPORTANT:**
1. The order matters! Output "fragment_summary" FIRST, then "chunks" SECOND, then "links" THIRD.
2. Every chunk MUST have a "type" field set to "user_focused".
3. Every chunk MUST have a "retention" field with one of the four valid values.
4. Every link MUST have a "strength" field with one of the three valid values.
5. The "fragment_summary" field is REQUIRED - it must always be present even if there are no user-focused chunks.
